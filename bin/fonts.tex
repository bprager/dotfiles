\usepackage{fontspec}
\usepackage{newunicodechar}
\usepackage{xcolor}

% Make fontspec robust and widen glyph coverage
\defaultfontfeatures{Ligatures=TeX,Renderer=HarfBuzz,Scale=MatchLowercase}

% Main fonts
\setmainfont{Noto Serif}[
  UprightFont = *,
  ItalicFont  = * Italic,
  BoldFont    = * Bold,
  BoldItalicFont = * Bold Italic,
  % Use explicit fallbacks for missing symbols/arrows
  FallbackFamilies = {Symbola, Noto Emoji, Apple Symbols, DejaVu Sans}
]
\setsansfont{Noto Sans}[
  FallbackFamilies = {Symbola, Noto Emoji, Apple Symbols, DejaVu Sans}
]
\setmonofont{Noto Sans Mono}[
  Scale=MatchLowercase,
  % Important: ensure code blocks can show emoji and symbols too
  FallbackFamilies = {Noto Emoji, Symbola, Apple Symbols, DejaVu Sans}
]
\setmathfont{Latin Modern Math}

% Emoji and symbols â€œhelperâ€ faces
\IfFontExistsTF{Symbola}{
  \newfontfamily\emoji{Symbola}[Renderer=HarfBuzz]
}{
  \IfFontExistsTF{Noto Emoji}{
    \newfontfamily\emoji{Noto Emoji}[Renderer=HarfBuzz]
  }{
    \IfFontExistsTF{DejaVu Sans}{
      \newfontfamily\emoji{DejaVu Sans}[Renderer=HarfBuzz]
    }{
      \newfontfamily\emoji{Latin Modern Roman}[Renderer=HarfBuzz]
    }
  }
}
\IfFontExistsTF{Apple Symbols}{
  \newfontfamily\symbolsfont{Apple Symbols}[Renderer=HarfBuzz]
}{
  \IfFontExistsTF{Symbola}{
    \newfontfamily\symbolsfont{Symbola}[Renderer=HarfBuzz]
  }{
    \IfFontExistsTF{Noto Sans Symbols}{
      \newfontfamily\symbolsfont{Noto Sans Symbols}[Renderer=HarfBuzz]
    }{
      \newfontfamily\symbolsfont{Latin Modern Roman}[Renderer=HarfBuzz]
    }
  }
}

% Emoji wrapper
\newcommand{\textemoji}[1]{%
  {\emoji\strut #1}%
}

% Unicode â†’ robust glyph or math mapping
% Arrows and math-ish
\newunicodechar{â†’}{{\symbolsfont â†’}}        % U+2192
\newunicodechar{â}{{\symbolsfont â†’}}        % map â€œlong arrowâ€ to same
\newunicodechar{â‰¤}{\ensuremath{\le}}         % U+2264
\newunicodechar{â‰ˆ}{\ensuremath{\approx}}     % U+2248

% Emojis (add as needed)
\newunicodechar{âœ…}{\textemoji{âœ…}}
\newunicodechar{âŒ}{\textemoji{âŒ}}
\newunicodechar{ğŸ¯}{\textemoji{ğŸ¯}}
\newunicodechar{ğŸ¬}{\textemoji{ğŸ¬}}
\newunicodechar{ğŸ“¹}{\textemoji{ğŸ“¹}}
\newunicodechar{ğŸ§ }{\textemoji{ğŸ§ }}
\newunicodechar{ğŸ”§}{\textemoji{ğŸ”§}}
\newunicodechar{ğŸ“£}{\textemoji{ğŸ“£}}
\newunicodechar{ğŸ“ˆ}{\textemoji{ğŸ“ˆ}}
\newunicodechar{ğŸ”}{\textemoji{ğŸ”}}
\newunicodechar{ğŸ”œ}{\textemoji{ğŸ”œ}}
\newunicodechar{ğŸ¥}{\textemoji{ğŸ¥}}
\newunicodechar{ğŸ’„}{\textemoji{ğŸ’„}}
\newunicodechar{ğŸ› }{\textemoji{ğŸ› }}
\newunicodechar{ğŸ¤}{\textemoji{ğŸ¤}}
\newunicodechar{ğŸ’­}{\textemoji{ğŸ’­}}
\newunicodechar{ğŸ²}{\textemoji{ğŸ²}}
\newunicodechar{ğŸŒ±}{\textemoji{ğŸŒ±}}
% Non-breaking hyphen (U+2011) â†’ regular hyphen with no break after it
\newunicodechar{^^^^2011}{\nobreakdash-}
% (optional) Hyphen (U+2010 and U+2011) as well, some sources use it
\newunicodechar{^^^^2010}{-}
\newunicodechar{^^^^2011}{\mbox{-}}

% Arrow, works in body and in PDF bookmarks
\providecommand{\texorpdfstring}[2]{#1}
\newcommand{\symbolarrow}{\texorpdfstring{\ensuremath{\rightarrow}}{->}}

% U+2E3B THREE-EM DASH (â¸»)
\providecommand{\texorpdfstring}[2]{#1}
\newcommand{\threeemdash}{\texorpdfstring{\rule[0.55ex]{3em}{0.12ex}}{---}}
\newunicodechar{â¸»}{\threeemdash{}}

% Fallback, if any raw Unicode arrow survives later filters
\newunicodechar{â†’}{\symbolarrow{}}
\newunicodechar{â}{\symbolarrow{}}


% Handle U+202F (narrow no-break space) as non-breaking
\catcode"202F=\active
\begingroup
  \lccode`\~="202F
  \lowercase{\endgroup\def~}{\nobreakspace}

% Strip VS16 if it sneaks through
\catcode`\ï¸=\active
\defï¸{}

% Emoji command shims used by the Lua filter
\newcommand{\emojicheckmark}{\textemoji{âœ…}}
\newcommand{\emojicrossmark}{\textemoji{âŒ}}
\newcommand{\emojitarget}{\textemoji{ğŸ¯}}
\newcommand{\emojifilm}{\textemoji{ğŸ¬}}
\newcommand{\emojivideo}{\textemoji{ğŸ“¹}}   % also used for ğŸ¥
\newcommand{\emojibrain}{\textemoji{ğŸ§ }}
\newcommand{\emojitool}{\textemoji{ğŸ”§}}    % also used for ğŸ› 
\newcommand{\emojimegaphone}{\textemoji{ğŸ“£}}
\newcommand{\emojichart}{\textemoji{ğŸ“ˆ}}
\newcommand{\emojisearch}{\textemoji{ğŸ”}}
\newcommand{\emojisoon}{\textemoji{ğŸ”œ}}
\newcommand{\emojimakeup}{\textemoji{ğŸ’„}}  % fixed typo
\newcommand{\emojihandshake}{\textemoji{ğŸ¤}}
\newcommand{\emojithought}{\textemoji{ğŸ’­}}
\newcommand{\emojidice}{\textemoji{ğŸ²}}
\newcommand{\emojiSeedling}{\textemoji{ğŸŒ±}}
\newcommand{\emojiGlobe}{\textemoji{ğŸŒ}}   % globe with meridians

